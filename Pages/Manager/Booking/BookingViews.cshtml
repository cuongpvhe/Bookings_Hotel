@page
@model Bookings_Hotel.Pages.Manager.Booking.BookingViewsModel
@{
    ViewData["Title"] = "Quản lý Booking";
    Layout = "~/Pages/Shared/Layout_admin.cshtml";
}

<h1>Quản lý Booking</h1>

<div>
    <label for="floorSelect">Chọn Tầng:</label>
    <select id="floorSelect" asp-for="SelectedFloor" asp-items="Model.Floors" onchange="loadRooms()">
        <option value="">-- Chọn Tầng --</option>
    </select>
</div>

<div id="roomsContainer" style="margin-top: 20px;">
    <label for="roomSelect">Chọn Phòng:</label>
    <select id="roomSelect" onchange="showBookingStatus(this.value)">
        <option value="">-- Chọn Phòng --</option>
    </select>
</div>

<div style="margin-top: 20px;">
    <label for="monthSelect">Chọn Tháng:</label>
    <select id="monthSelect" onchange="showBookingStatus($('#roomSelect').val())">
        @for (int month = 1; month <= 12; month++)
        {
            <option value="@month">@month</option>
        }
    </select>

    <label for="yearSelect">Chọn Năm:</label>
    <select id="yearSelect" onchange="showBookingStatus($('#roomSelect').val())">
        @for (int year = DateTime.Now.Year - 1; year <= DateTime.Now.Year + 1; year++)
        {
            <option value="@year">@year</option>
        }
    </select>
</div>

<div id="bookingStatusGrid" style="margin-top: 20px; display: none;"></div>

@section Scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        function loadRooms() {
            const floorId = $('#floorSelect').val();
            $('#roomSelect').empty();
            $('#roomSelect').append('<option value="">-- Chọn Phòng --</option>');

            if (floorId) {
                $.ajax({
                    url: '@Url.Page("BookingViews", "GetRoomsByFloor")',
                    type: 'GET',
                    data: { floorId: floorId },
                    success: function (data) {
                        $.each(data, function (index, room) {
                            $('#roomSelect').append('<option value="' + room.roomId + '">' + room.roomNumber + '</option>');
                        });
                    },
                    error: function (xhr, status, error) {
                        alert('Đã xảy ra lỗi khi lấy dữ liệu: ' + error);
                    }
                });
            }
        }

        function showBookingStatus(roomId) {
            const selectedMonth = $('#monthSelect').val();
            const selectedYear = $('#yearSelect').val();

            if (!roomId) {
                $('#bookingStatusGrid').hide();
                return;
            }

            $.ajax({
                url: '@Url.Page("BookingViews", "GetBookingStatus")',
                type: 'GET',
                data: { roomId: roomId, month: selectedMonth, year: selectedYear },
                success: function (data) {
                    const bookingGrid = $('#bookingStatusGrid');
                    bookingGrid.empty();
                    bookingGrid.append('<h4>Lịch Booking - Tháng ' + selectedMonth + ' Năm ' + selectedYear + '</h4><div id="calendar"></div>');

                    // Tạo đối tượng để đánh dấu ngày đã được booked
                    const bookingDays = {};
                    $.each(data, function (index, status) {
                        const checkInDate = new Date(status.checkIn);
                        const checkOutDate = new Date(status.checkOut);

                        // Lặp qua các ngày từ check-in đến check-out (bao gồm cả ngày check-out)
                        for (let d = new Date(checkInDate); d <= checkOutDate; d.setDate(d.getDate() + 1)) {
                            const dateStr = d.toLocaleDateString(); // Định dạng ngày
                            bookingDays[dateStr] = true; // Đánh dấu ngày đã được booked
                        }
                    });

                    // Tạo lịch
                    const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate(); // Lấy số ngày trong tháng
                    let calendarHTML = '<table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">';
                    calendarHTML += '<thead><tr>';

                    // Hiển thị tiêu đề cho các ngày trong tháng
                    for (let i = 1; i <= daysInMonth; i++) {
                        calendarHTML += `<th>${i}</th>`;
                    }

                    calendarHTML += '</tr></thead><tbody><tr>';

                    // Hiển thị trạng thái cho từng ngày
                    for (let i = 1; i <= daysInMonth; i++) {
                        let date = new Date(selectedYear, selectedMonth - 1, i); // tháng bắt đầu từ 0
                        let dateStr = date.toLocaleDateString();
                        let status = bookingDays[dateStr] ? 'Đã Booked' : 'Còn Trống';
                        let bgColor = bookingDays[dateStr] ? '#ffcccc' : '#ccffcc'; // Màu nền cho ngày đã booked và còn trống
                        calendarHTML += `<td style="background-color: ${bgColor}; padding: 10px;">${status}</td>`;
                    }

                    calendarHTML += '</tr></tbody></table>';
                    bookingGrid.find('#calendar').html(calendarHTML);
                    bookingGrid.show();
                },
                error: function (xhr, status, error) {
                    alert('Đã xảy ra lỗi khi lấy dữ liệu: ' + error);
                }
            });
        }
    </script>
}
